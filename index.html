<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Tetris — Stable</title>
<style>
  :root{--bg:#111;--panel:#222;--muted:#888}
  html,body{
    height:100%;margin:0;background:var(--bg);color:#fff;
    font-family:system-ui,-apple-system,Segoe UI,Roboto;
    overflow:hidden; /* ADDED: prevents page scroll */
  }

  header{background:var(--panel);padding:12px;text-align:center}
  h1{margin:0;font-size:20px}
  #score{margin-top:6px;font-size:15px;color:var(--muted)}

  #game-wrap{
    display:flex;flex:1;align-items:flex-start;justify-content:center;
    padding:12px;box-sizing:border-box
  }

  #game-container{
    width:100%;max-width:420px;
    height:calc(100dvh - 210px); /* adjusted for new menu */
    display:flex;align-items:center;justify-content:center;
    position:relative
  }

  canvas{
    background:var(--panel);display:block;border-radius:6px;
    touch-action:none
  }

  /* Controls */
  #controls{
    position:fixed;left:0;right:0;bottom:8px;
    display:flex;justify-content:space-around;
    padding:10px 16px;gap:12px;
    background:rgba(0,0,0,0.25)
  }

  .btn{
    width:68px;height:68px;border-radius:12px;border:0;
    background:#444;color:#fff;font-size:26px;
    display:flex;align-items:center;justify-content:center;
    touch-action:manipulation
  }
  .btn:active{background:#666}

  /* ADDED: Game control bar */
  #game-menu{
    display:flex;justify-content:center;gap:10px;
    padding:8px;background:#0003;
  }
  .menu-btn{
    padding:8px 14px;border-radius:8px;
    background:#444;border:0;color:white;font-size:14px;
  }
  .menu-btn:active{background:#666}

</style>
</head>
<body>

<header>
  <h1>TETRIS</h1>
  <div id="score">Score: 0</div>
</header>

<!-- ADDED: Game control menu -->
<div id="game-menu">
  <button class="menu-btn" id="startBtn">Start</button>
  <button class="menu-btn" id="pauseBtn">Pause</button>
  <button class="menu-btn" id="resumeBtn">Resume</button>
  <button class="menu-btn" id="restartBtn">Restart</button>
  <button class="menu-btn" id="endBtn">End</button>
</div>

<div id="game-wrap">
  <div id="game-container">
    <canvas id="board"></canvas>
  </div>
</div>

<div id="controls">
  <button class="btn" id="left">←</button>
  <button class="btn" id="rotate">⟳</button>
  <button class="btn" id="right">→</button>
  <button class="btn" id="down">↓</button>
</div>

<script>
/* ========= CONFIG ========= */
const COLS = 12, ROWS = 20;
const PADDING = 12;
const MAX_CANVAS_WIDTH = 420;
const MIN_CELL = 18;

/* ========= DOM ========= */
const canvas = document.getElementById("board");
const ctx = canvas.getContext("2d",{alpha:false});
const scoreEl = document.getElementById("score");
const container = document.getElementById("game-container");

/* ========= STATE ========= */
let arena, player, lastTime=0, dropCounter=0, dropInterval=700;
let running = false;  // ADDED: start/pause system

const COLORS=[null,"#f1c40f","#e67e22","#9b59b6","#3498db","#1abc9c","#e74c3c","#2ecc71"];

/* ========= MATRIX ========= */
function createMatrix(w,h){
  return Array.from({length:h},()=>Array(w).fill(0));
}

function createPiece(type){
  if(type==="T") return [[0,1,0],[1,1,1]];
  if(type==="O") return [[2,2],[2,2]];
  if(type==="L") return [[0,0,3],[3,3,3]];
  if(type==="J") return [[4,0,0],[4,4,4]];
  if(type==="I") return [[0,5,0,0],[0,5,0,0],[0,5,0,0],[0,5,0,0]];
  if(type==="S") return [[0,6,6],[6,6,0],[0,0,0]];
  if(type==="Z") return [[7,7,0],[0,7,7],[0,0,0]];
}

function randPiece(){
  const p="ILJOTSZ";
  return p[Math.floor(Math.random()*p.length)];
}

/* ========= CANVAS RESIZE ========= */
let cellW=20,cellH=20;

function resizeCanvas(){
  const rect=container.getBoundingClientRect();
  let availH=rect.height - (PADDING*2);
  let availW=Math.min(rect.width - (PADDING*2), MAX_CANVAS_WIDTH);

  const fromH=Math.floor(availH/ROWS);
  const fromW=Math.floor(availW/COLS);
  const base=Math.max(Math.min(fromH,fromW),MIN_CELL);

  const w=base*COLS;
  const h=base*ROWS;

  canvas.style.width=w+"px";
  canvas.style.height=h+"px";
  canvas.width=w;
  canvas.height=h;

  cellW=w/COLS;
  cellH=h/ROWS;

  draw();
}

/* ========= DRAW ========= */
function draw(){
  ctx.fillStyle="#222";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  for(let y=0;y<ROWS;y++){
    for(let x=0;x<COLS;x++){
      if(arena[y][x]) drawCell(x,y,COLORS[arena[y][x]]);
    }
  }

  if(player.matrix){
    for(let y=0;y<player.matrix.length;y++){
      for(let x=0;x<player.matrix[y].length;x++){
        if(player.matrix[y][x]){
          drawCell(x+player.pos.x, y+player.pos.y, COLORS[player.matrix[y][x]]);
        }
      }
    }
  }
}

function drawCell(x,y,color){
  if(y<0) return;
  ctx.fillStyle=color;
  ctx.fillRect(
    x*cellW+1, y*cellH+1,
    cellW-2, cellH-2
  );
}

/* ========= COLLISIONS ========= */
function collide(arena,player){
  const m=player.matrix,o=player.pos;
  for(let y=0;y<m.length;y++){
    for(let x=0;x<m[y].length;x++){
      if(!m[y][x]) continue;
      const ax=x+o.x, ay=y+o.y;
      if(ay>=ROWS || ax<0 || ax>=COLS) return true;
      if(ay>=0 && arena[ay][ax]!=0) return true;
    }
  }
  return false;
}

function mergePlayer(){
  player.matrix.forEach((row,y)=>{
    row.forEach((v,x)=>{
      if(v && player.pos.y+y>=0){
        arena[player.pos.y+y][player.pos.x+x]=v;
      }
    });
  });
}

/* ========= LINES ========= */
function sweep(){
  let lines=0;
  for(let y=ROWS-1;y>=0;y--){
    if(arena[y].every(v=>v!=0)){
      arena.splice(y,1);
      arena.unshift(new Array(COLS).fill(0));
      lines++;y++;
    }
  }
  if(lines) player.score+=lines*10;
  updateScore();
}

/* ========= PLAYER ========= */
function playerReset(){
  player.matrix=createPiece(randPiece());
  player.pos.x=Math.floor((COLS - player.matrix[0].length)/2);
  player.pos.y=-2;

  if(collide(arena,player)){
    arena=createMatrix(COLS,ROWS);
    player.score=0;
    updateScore();
  }
}

function playerDrop(){
  player.pos.y++;
  if(collide(arena,player)){
    player.pos.y--;
    mergePlayer();
    sweep();
    playerReset();
  }
  dropCounter=0;
}

function playerMove(d){
  player.pos.x+=d;
  if(collide(arena,player)) player.pos.x-=d;
}

function rotateMatrix(m){
  for(let y=0;y<m.length;y++){
    for(let x=0;x<y;x++){
      [m[x][y],m[y][x]]=[m[y][x],m[x][y]];
    }
  }
  m.forEach(r=>r.reverse());
}

function playerRotate(){
  const copy=player.matrix.map(r=>r.slice());
  rotateMatrix(player.matrix);

  const kicks=[0,-1,1,-2,2];
  for(const k of kicks){
    player.pos.x+=k;
    if(!collide(arena,player)) return;
    player.pos.x-=k;
  }
  player.matrix=copy;
}

/* ========= GAME LOOP ========= */
function update(t=0){
  if(!running) return;  // ADDED: pause system

  const delta=t-lastTime;
  lastTime=t;
  dropCounter+=delta;

  if(dropCounter>dropInterval) playerDrop();

  draw();
  requestAnimationFrame(update);
}

/* ========= SCORE ========= */
function updateScore(){
  scoreEl.textContent="Score: "+player.score;
}

/* ========= BUTTONS ========= */
function bindBtn(id,fn){
  const el=document.getElementById(id);
  el.addEventListener("touchstart", e=>{e.preventDefault();fn();}, {passive:false});
  el.addEventListener("mousedown", e=>{e.preventDefault();fn();});
}

bindBtn("left", ()=>playerMove(-1));
bindBtn("right", ()=>playerMove(1));
bindBtn("down", ()=>playerDrop());
bindBtn("rotate", ()=>playerRotate());

/* ========= GAME MENU BUTTONS ========= */
document.getElementById("startBtn").onclick=function(){
  if(!running){
    running=true;
    lastTime=performance.now();
    requestAnimationFrame(update);
  }
};

document.getElementById("pauseBtn").onclick=function(){
  running=false;
};

document.getElementById("resumeBtn").onclick=function(){
  if(!running){
    running=true;
    lastTime=performance.now();
    requestAnimationFrame(update);
  }
};

document.getElementById("restartBtn").onclick=function(){
  init();
  running=true;
};

document.getElementById("endBtn").onclick=function(){
  running=false;
};

/* ========= INIT ========= */
function init(){
  arena=createMatrix(COLS,ROWS);
  player={pos:{x:0,y:0},matrix:null,score:0};
  playerReset();
  updateScore();
  resizeCanvas();
}

window.addEventListener("resize", ()=>setTimeout(resizeCanvas,120));

document.addEventListener("touchstart", e=>{
  if(e.touches.length>1) e.preventDefault();
},{passive:false});

init();

</script>
</body>
</html>
